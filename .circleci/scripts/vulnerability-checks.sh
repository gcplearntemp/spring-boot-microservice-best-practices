#!/usr/bin/env bash

#### Emoji Function
emojiFunction() {
  for i in {1..95}; do
    printf "$1"
  done
  printf '\n'
}

#### Install Trivy in container
install_trivy() {
  apk add --update-cache --upgrade curl rpm
  VERSION=$(
    curl --silent "https://api.github.com/repos/aquasecurity/trivy/releases/latest" |
      grep '"tag_name":' |
      sed -E 's/.*"v([^"]+)".*/\1/'
  )
  wget https://github.com/aquasecurity/trivy/releases/download/v"${VERSION}"/trivy_"${VERSION}"_Linux-64bit.tar.gz
  tar zxvf trivy_"${VERSION}"_Linux-64bit.tar.gz
  mv trivy /usr/local/bin
}

#### Start Scanning the image locally & publish report
echo "Installing Trivy...."
install_trivy

echo "Starting vulnerability checks...."
TAG=$(cat version.txt)
echo "Scanning Tag : ${TAG}"
mkdir reports

time_stamp="$(date +'%d-%m-%Y-%r')"
echo "Checking Vulnerabilities at: ${time_stamp}"
#### The real game starts here
trivy --exit-code 0 --no-progress "${DOCKER_USER}/${DOCKER_IMAGE}:${TAG}" >reports/"vulnerability-report-${time_stamp}".txt

critical_vulnerability=$(grep CRITICAL: reports/"vulnerability-report-${time_stamp}".txt | sed -n -e 's/^.*CRITICAL: //p' | cut -c1-1)
high_vulnerability=$(grep CRITICAL: reports/"vulnerability-report-${time_stamp}".txt | sed -n -e 's/^.*HIGH: //p' | cut -c1-1)
echo "Vulnerabilities Report Generated..."

#### Check if the report has Critical or High Vulnerability
scan_status=$(grep Total: reports/"vulnerability-report-${time_stamp}".txt)
if [[ "${critical_vulnerability}" != "0" || "${high_vulnerability}" != "0" ]]; then
  emojiFunction "\xE2\x98\xA0"
  echo "Critical or High Vulnerabilities Identified review the attached report."
  echo "Scan status : ${scan_status}"
  echo "Fix the vulnerabilities to proceed with the deployment."
  emojiFunction "\xE2\x98\xA0"
  exit 1
else
  emojiFunction "\xE2\x99\xA0"
  echo "Everything is good."
  echo "Scan status : ${scan_status}"
  echo "No Critical and High Vulnerabilities Identified, review full list of other vulnerabilities identified."
  emojiFunction "\xE2\x99\xA0"
fi
echo "Trivy Vulnerabilities Check Ends.."
